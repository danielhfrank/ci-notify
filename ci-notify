#!/usr/bin/env ruby

PENDING=2
NO_STATUS=3
GITHUB_SUCCESS="✔︎"
GITHUB_FALURE="✖︎"
return_txt = ""

project_name = `basename $(git rev-parse --show-toplevel)`

loop do
  return_txt = `hub ci-status -v`
  break unless [PENDING, NO_STATUS].include?($?.exitstatus)
  sleep(1)
end

def notify(status_txt, title, url_args)
    system("terminal-notifier -message 'Build #{status_txt}' -title '#{title}' #{url_args}")
end

status_rows = return_txt.split("\n").map{ |l| l.split("\t", 3).map{ |s| s.strip} }
rows_by_status = status_rows.group_by{ |l| l[0] }

if rows_by_status[GITHUB_FALURE].nil?
    # success
    notify(GITHUB_SUCCESS, project_name, '')
else
    rows_by_status[GITHUB_FALURE].each do |fail,test_name,test_url|
        notify(GITHUB_FALURE, test_name, "-open #{test_url}")
    end
end
